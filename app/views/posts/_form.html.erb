<head>
  <script>
      function previewImage(input) {
          var preview = document.getElementById('image-preview');
          preview.innerHTML = ''; // Clear any previous preview

          if (input.files && input.files[0]) {
              var reader = new FileReader();

              reader.onload = function (e) {
                  var img = document.createElement('img');
                  img.setAttribute('src', e.target.result);
                  img.setAttribute('alt', 'Image Preview');
                  img.style.maxWidth = '100%';// Adjust the maximum width as needed

                  preview.appendChild(img);
              };

              reader.readAsDataURL(input.files[0]);
          }
      }

      document.addEventListener('DOMContentLoaded', function () {
          // Attach an event listener to the form submit button
          var newPostForm = document.getElementById('new-post-form');
          newPostForm.addEventListener('submit', function (event) {
              event.preventDefault(); // Prevent the default form submission

              // Serialize form data
              var formData = new FormData(newPostForm);

              // Make an AJAX request
              var xhr = new XMLHttpRequest();
              xhr.open('POST', '<%= topic_posts_path(@topic) %>', true);
              xhr.setRequestHeader('X-CSRF-Token', Rails.csrfToken());
              xhr.onload = function () {
                  if (xhr.status === 200) {
                      var response = JSON.parse(xhr.responseText);
                      var newPostHtml = response.html;

                      // Append the new post HTML to the list of posts
                      var postList = document.getElementById('post-list');
                      postList.insertAdjacentHTML('afterbegin', newPostHtml);

                      // Clear the form after successful submission
                      newPostForm.reset();
                      document.getElementById('image-preview').innerHTML = '';
                  } else {
                      alert('Error creating post');
                  }
              };
              xhr.send(formData);
          });
      });

  </script>
  <%= stylesheet_link_tag 'posts' %>
</head>
<%= form_with(model: [@topic,post],local: false, id: 'new-post-form') do |form| %>
  <% if post.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(post.errors.count, "error") %> prohibited this post from being saved:</h2>

      <ul>
        <% post.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :name %>
    <%= form.text_field :name %>
  </div>

  <div class="field">
    <%= form.label :content %>
    <%= form.text_field :content %>
  </div>

  <div class="field">
    <%= form.label :date %>
    <%= form.datetime_select :date %>
  </div>

  <div class="field">

    <%= form.label :tag %>

      <%=form.collection_select(:tag_ids, Tag.all, :id, :tag, {prompt: "Choose a tag"},{multiple: true})%>
    <%= form.text_field :new_tag, placeholder: "New Tag Name" %>
  </div>

  <div class="field">
    <%= form.label :image %>
    <%= form.file_field :image, onchange: 'previewImage(this);' %>
  </div>

  <div id="image-preview">
    <!-- Preview will be displayed here -->
  </div>


  <div class="actions">
    <%= form.submit  %>
  </div>
<% end %>
